<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InstaBid Calculation Diagnostic Tool</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Monaco', 'Consolas', monospace;
      background: #0d1117;
      color: #e6edf3;
      padding: 20px;
      min-height: 100vh;
    }
    
    h1 {
      color: #00d4ff;
      margin-bottom: 5px;
      font-size: 1.5rem;
    }
    
    .subtitle {
      color: #8b949e;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    
    .container {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      max-width: 1400px;
    }
    
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
    }
    
    .panel {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
    }
    
    .panel h2 {
      color: #00d4ff;
      font-size: 1rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #30363d;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      color: #8b949e;
      font-size: 0.8rem;
      margin-bottom: 5px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #e6edf3;
      font-family: inherit;
      font-size: 0.9rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #00d4ff;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #00d4ff, #00a8cc);
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      margin-top: 10px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    }
    
    .output {
      background: #0d1117;
      border-radius: 6px;
      padding: 15px;
      max-height: 75vh;
      overflow-y: auto;
    }
    
    .log-entry {
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 0.85rem;
      line-height: 1.4;
    }
    
    .log-header {
      background: rgba(0, 212, 255, 0.15);
      border-left: 3px solid #00d4ff;
      color: #00d4ff;
      font-weight: 600;
    }
    
    .log-source {
      background: rgba(138, 43, 226, 0.15);
      border-left: 3px solid #a855f7;
      color: #c4b5fd;
    }
    
    .log-lookup {
      background: rgba(255, 193, 7, 0.1);
      border-left: 3px solid #ffc107;
      color: #ffc107;
    }
    
    .log-calc {
      background: rgba(0, 255, 136, 0.1);
      border-left: 3px solid #00ff88;
      color: #00ff88;
    }
    
    .log-warning {
      background: rgba(255, 107, 107, 0.15);
      border-left: 3px solid #ff6b6b;
      color: #ff6b6b;
    }
    
    .log-result {
      background: rgba(0, 212, 255, 0.2);
      border-left: 3px solid #00d4ff;
      color: #fff;
      font-weight: 600;
    }
    
    .log-breakdown {
      background: #21262d;
      border-left: 3px solid #8b949e;
      color: #8b949e;
      margin-left: 15px;
    }
    
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .tag-file { background: #238636; color: #fff; }
    .tag-func { background: #1f6feb; color: #fff; }
    .tag-db { background: #a855f7; color: #fff; }
    .tag-cache { background: #f97316; color: #fff; }
    .tag-default { background: #6b7280; color: #fff; }
    .tag-override { background: #ec4899; color: #fff; }
    
    .code {
      font-family: 'Monaco', 'Consolas', monospace;
      background: #000;
      padding: 2px 6px;
      border-radius: 3px;
      color: #00d4ff;
      font-size: 0.8rem;
    }
    
    .value {
      color: #00ff88;
      font-weight: 600;
    }
    
    .formula {
      background: #1a1a2e;
      padding: 10px;
      border-radius: 4px;
      margin: 5px 0;
      font-size: 0.85rem;
      border: 1px dashed #30363d;
    }
    
    .status-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px;
      background: #21262d;
      border-radius: 6px;
      font-size: 0.8rem;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-dot.green { background: #00ff88; }
    .status-dot.yellow { background: #ffc107; }
    .status-dot.red { background: #ff6b6b; }
    
    .divider {
      border: none;
      border-top: 1px dashed #30363d;
      margin: 10px 0;
    }
    
    .summary {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 255, 136, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
    }
    
    .summary h3 {
      color: #00d4ff;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .summary-row:last-child {
      border-bottom: none;
      font-weight: 600;
      color: #00ff88;
      font-size: 1.1rem;
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üîç InstaBid Calculation Diagnostic Tool</h1>
  <p class="subtitle">Trace every calculation step ‚Ä¢ See where each value originates</p>
  
  <div class="container">
    <div class="panel">
      <h2>üì• Test Input</h2>
      
      <div class="form-group">
        <label>Trade</label>
        <select id="trade">
          <option value="roofing">Roofing</option>
          <option value="hvac">HVAC</option>
          <option value="electrical">Electrical</option>
          <option value="plumbing">Plumbing</option>
          <option value="flooring">Flooring</option>
          <option value="painting">Painting</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>State</label>
        <select id="state">
          <option value="WA">WA - Washington</option>
          <option value="OR">OR - Oregon</option>
          <option value="CA">CA - California</option>
          <option value="TX">TX - Texas</option>
          <option value="NY">NY - New York</option>
          <option value="FL">FL - Florida</option>
          <option value="IL">IL - Illinois</option>
          <option value="OH">OH - Ohio</option>
          <option value="AK">AK - Alaska</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Square Footage</label>
        <input type="number" id="sqft" value="2000" min="100" max="10000">
      </div>
      
      <div id="trade-specific-inputs"></div>
      
      <div class="form-group">
        <label>Simulate Contractor Override?</label>
        <select id="hasOverride">
          <option value="no">No - Use Defaults</option>
          <option value="yes">Yes - Test Override</option>
        </select>
      </div>
      
      <button class="btn" onclick="runDiagnostic()">üî¨ Run Diagnostic</button>
    </div>
    
    <div class="panel">
      <h2>üìä Calculation Trace</h2>
      
      <div class="status-bar">
        <div class="status-item">
          <span class="status-dot" id="status-cache"></span>
          <span>STATE_MULTIPLIERS_CACHE</span>
        </div>
        <div class="status-item">
          <span class="status-dot" id="status-bls"></span>
          <span>bls_labor_rates</span>
        </div>
        <div class="status-item">
          <span class="status-dot" id="status-override"></span>
          <span>Contractor Overrides</span>
        </div>
      </div>
      
      <div class="output" id="output">
        <div class="log-entry log-header">
          Click "Run Diagnostic" to trace a calculation...
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // SIMULATED SERVER.JS DATA STRUCTURES
    // ============================================
    
    // Simulating your STATE_MULTIPLIERS_CACHE
    // ISSUE: In your code, this may not be loaded!
    const STATE_MULTIPLIERS_CACHE = {
      'WA': 1.10, 'OR': 1.10, 'CA': 1.30, 'TX': 0.95,
      'NY': 1.25, 'FL': 0.92, 'IL': 1.00, 'OH': 0.92,
      'AK': 1.40, 'HI': 1.45
    };
    
    // Simulating your DEFAULT_PRICING
    const DEFAULT_PRICING = {
      roofing: {
        pitch_low: 1.0, pitch_med: 1.2, pitch_high: 1.4, pitch_steep: 1.8,
        story_1: 1.0, story_2: 1.3, story_3: 1.6,
        mat_asphalt: 2.5, mat_arch: 3.5, mat_metal: 5.0, mat_tile: 7.0, mat_slate: 12.0,
        tearoff_cost: 1500, plywood_cost: 4.5, chimney_cost: 400
      },
      hvac: {
        hvac_furnace: 3500, hvac_ac: 4000, hvac_heatpump: 5500, hvac_minisplit: 2500,
        hvac_duct: 15, hvac_thermostat: 350
      },
      electrical: {
        elec_panel_100: 1800, elec_panel_200: 2500, elec_outlet: 125, elec_switch: 110
      },
      plumbing: {
        plumb_toilet: 350, plumb_sink: 400, plumb_heater_tank: 1800, plumb_heater_tankless: 3200
      },
      flooring: {
        floor_carpet: 3.5, floor_vinyl: 4.0, floor_hardwood_eng: 8.0, floor_tile_ceramic: 6.0
      },
      painting: {
        paint_int_walls_1: 1.5, paint_int_walls_2: 2.5, paint_ext_siding_1: 2.0
      }
    };
    
    // Simulating configData (contractor overrides)
    let configData = {
      roofing: {},
      hvac: {},
      electrical: {},
      plumbing: {},
      flooring: {},
      painting: {}
    };
    
    // State labor rate fallbacks
    const stateFallbacks = {
      'AL': 38, 'AK': 52, 'AZ': 42, 'AR': 36, 'CA': 58,
      'CO': 48, 'CT': 52, 'DE': 46, 'FL': 40, 'GA': 42,
      'HI': 54, 'ID': 40, 'IL': 50, 'IN': 42, 'IA': 44,
      'KS': 42, 'KY': 40, 'LA': 40, 'ME': 44, 'MD': 50,
      'MA': 56, 'MI': 46, 'MN': 50, 'MS': 36, 'MO': 44,
      'MT': 42, 'NE': 44, 'NV': 48, 'NH': 48, 'NJ': 54,
      'NM': 40, 'NY': 58, 'NC': 40, 'ND': 48, 'OH': 44,
      'OK': 38, 'OR': 50, 'PA': 48, 'RI': 52, 'SC': 38,
      'SD': 42, 'TN': 40, 'TX': 42, 'UT': 44, 'VT': 46,
      'VA': 46, 'WA': 52, 'WV': 40, 'WI': 46, 'WY': 44
    };
    
    // ============================================
    // DIAGNOSTIC FUNCTIONS
    // ============================================
    
    let logs = [];
    
    function log(type, message) {
      logs.push({ type, message });
    }
    
    function renderLogs() {
      const output = document.getElementById('output');
      output.innerHTML = logs.map(l => 
        `<div class="log-entry log-${l.type}">${l.message}</div>`
      ).join('');
    }
    
    function tag(type, text) {
      return `<span class="tag tag-${type}">${text}</span>`;
    }
    
    function code(text) {
      return `<span class="code">${text}</span>`;
    }
    
    function val(text) {
      return `<span class="value">${text}</span>`;
    }
    
    // Simulated getPrice with logging
    function getPrice(trade, key, useOverride = false) {
      if (useOverride && configData[trade] && configData[trade][key] !== undefined) {
        log('source', `${tag('override', 'OVERRIDE')} ${code(`configData.${trade}.${key}`)} = ${val(configData[trade][key])}`);
        log('breakdown', `‚Ü≥ Contractor set custom value, overriding default`);
        return configData[trade][key];
      }
      
      const value = DEFAULT_PRICING[trade]?.[key];
      log('source', `${tag('default', 'DEFAULT')} ${code(`DEFAULT_PRICING.${trade}.${key}`)} = ${val(value)}`);
      log('breakdown', `‚Ü≥ From ${code('server.js')} line ~45-120 (hardcoded defaults)`);
      return value;
    }
    
    // Simulated getHourlyRate with logging
    function getHourlyRate(state, trade) {
      log('lookup', `${tag('func', 'getHourlyRate()')} Looking up labor rate for ${val(state)} / ${val(trade)}`);
      
      // First try BLS table
      log('lookup', `${tag('db', 'QUERY')} ${code('SELECT hourly_rate FROM bls_labor_rates WHERE state_code = $1 AND trade_type = $2')}`);
      
      // Simulate: BLS table might not exist or have data
      const blsExists = false; // Simulating missing table
      
      if (!blsExists) {
        log('warning', `‚ö†Ô∏è No BLS rate found - table may not exist or be empty!`);
        log('breakdown', `‚Ü≥ ${code('bls_labor_rates')} table not created in ${code('initDatabase()')}`);
      }
      
      // Fallback to state rates
      const rate = stateFallbacks[state] || 45;
      log('source', `${tag('default', 'FALLBACK')} Using ${code('stateFallbacks[' + state + ']')} = ${val('$' + rate + '/hr')}`);
      log('breakdown', `‚Ü≥ From ${code('server.js')} line ~180-195 (hardcoded state fallbacks)`);
      
      return rate;
    }
    
    // Simulated regional multiplier lookup
    function getRegionalMultiplier(state) {
      log('lookup', `${tag('func', 'getRegionalMultiplier()')} Looking up multiplier for ${val(state)}`);
      
      // Check if cache exists
      const cacheLoaded = Object.keys(STATE_MULTIPLIERS_CACHE).length > 0;
      
      if (!cacheLoaded) {
        log('warning', `‚ö†Ô∏è STATE_MULTIPLIERS_CACHE is empty!`);
        log('breakdown', `‚Ü≥ Cache may not be loaded - check for ${code('loadStateMultipliers()')} function`);
        return 1.0;
      }
      
      const mult = STATE_MULTIPLIERS_CACHE[state];
      
      if (mult) {
        log('source', `${tag('cache', 'CACHE')} ${code('STATE_MULTIPLIERS_CACHE[' + state + ']')} = ${val(mult + 'x')}`);
        log('breakdown', `‚Ü≥ Should load from ${code('state_multipliers')} table at startup`);
        return mult;
      } else {
        log('warning', `‚ö†Ô∏è No multiplier for ${state}, defaulting to 1.0`);
        return 1.0;
      }
    }
    
    // ============================================
    // MAIN DIAGNOSTIC RUNNER
    // ============================================
    
    function runDiagnostic() {
      logs = [];
      
      const trade = document.getElementById('trade').value;
      const state = document.getElementById('state').value;
      const sqft = parseInt(document.getElementById('sqft').value) || 2000;
      const useOverride = document.getElementById('hasOverride').value === 'yes';
      
      // Set up test override if requested
      if (useOverride) {
        configData.roofing.mat_arch = 5.00;
        configData.hvac.hvac_furnace = 5000;
      } else {
        configData = { roofing: {}, hvac: {}, electrical: {}, plumbing: {}, flooring: {}, painting: {} };
      }
      
      // Update status indicators
      document.getElementById('status-cache').className = 'status-dot green';
      document.getElementById('status-bls').className = 'status-dot red';
      document.getElementById('status-override').className = useOverride ? 'status-dot green' : 'status-dot yellow';
      
      log('header', `üî¨ DIAGNOSTIC: ${trade.toUpperCase()} estimate for ${state}`);
      log('breakdown', `Input: ${sqft} sqft | Override: ${useOverride ? 'YES' : 'NO'}`);
      
      // Step 1: Entry point
      log('header', `üìç STEP 1: Entry Point`);
      log('source', `${tag('file', 'server.js')} ${tag('func', 'calculateTradeEstimate()')} called`);
      log('breakdown', `‚Ü≥ Line ~200: async function calculateTradeEstimate(trade, data, hourlyRate, state, msa)`);
      
      // Step 2: Get hourly rate
      log('header', `üìç STEP 2: Labor Rate Lookup`);
      const hourlyRate = getHourlyRate(state, trade);
      
      // Step 3: Get regional multiplier
      log('header', `üìç STEP 3: Regional Multiplier`);
      const regionalMultiplier = getRegionalMultiplier(state);
      
      // Step 4: Trade-specific calculation
      log('header', `üìç STEP 4: Trade-Specific Calculation`);
      
      let laborHours = 0;
      let materialCost = 0;
      let equipmentCost = 0;
      
      switch(trade) {
        case 'roofing':
          log('source', `${tag('file', 'server.js')} Entering ${code('case "roofing":')} block (line ~210)`);
          
          const matCost = getPrice('roofing', 'mat_arch', useOverride);
          const pitchMult = getPrice('roofing', 'pitch_med', useOverride);
          const storyMult = getPrice('roofing', 'story_1', useOverride);
          
          log('calc', `üìê Calculating labor hours...`);
          const baseHoursPer100 = 2.5;
          log('breakdown', `‚Ü≥ Base: ${baseHoursPer100} hrs per 100 sqft (hardcoded line ~220)`);
          log('breakdown', `‚Ü≥ √ó pitch multiplier: ${pitchMult}`);
          log('breakdown', `‚Ü≥ √ó story multiplier: ${storyMult}`);
          
          laborHours = (sqft / 100) * baseHoursPer100 * pitchMult * storyMult;
          log('calc', `Labor hours = (${sqft}/100) √ó ${baseHoursPer100} √ó ${pitchMult} √ó ${storyMult} = ${val(laborHours.toFixed(2) + ' hrs')}`);
          
          log('calc', `üìê Calculating material cost...`);
          materialCost = sqft * matCost;
          log('breakdown', `‚Ü≥ ${sqft} sqft √ó $${matCost}/sqft = $${materialCost.toFixed(2)}`);
          
          materialCost *= regionalMultiplier;
          log('calc', `Applying regional multiplier: $${(materialCost/regionalMultiplier).toFixed(2)} √ó ${regionalMultiplier} = ${val('$' + materialCost.toFixed(2))}`);
          
          equipmentCost = 350;
          log('source', `${tag('default', 'HARDCODED')} Equipment cost = ${val('$350')} (line ~280)`);
          break;
          
        case 'hvac':
          log('source', `${tag('file', 'server.js')} Entering ${code('case "hvac":')} block (line ~285)`);
          
          const furnaceCost = getPrice('hvac', 'hvac_furnace', useOverride);
          const thermostat = getPrice('hvac', 'hvac_thermostat', useOverride);
          
          let sizeMultiplier = 1.0;
          if (sqft < 1500) sizeMultiplier = 0.9;
          else if (sqft > 2500) sizeMultiplier = 1.2;
          
          log('calc', `Size multiplier for ${sqft} sqft = ${val(sizeMultiplier)}`);
          
          laborHours = 12;
          log('source', `${tag('default', 'HARDCODED')} Labor hours for furnace = ${val('12 hrs')} (line ~300)`);
          
          materialCost = (furnaceCost * sizeMultiplier) + thermostat + 50 + 150;
          log('calc', `Material = ($${furnaceCost} √ó ${sizeMultiplier}) + $${thermostat} + $50 + $150 = ${val('$' + materialCost.toFixed(2))}`);
          
          materialCost *= regionalMultiplier;
          log('calc', `Applying regional multiplier: √ó ${regionalMultiplier} = ${val('$' + materialCost.toFixed(2))}`);
          
          equipmentCost = 200;
          log('source', `${tag('default', 'HARDCODED')} Equipment cost = ${val('$200')}`);
          break;
          
        case 'electrical':
          log('source', `${tag('file', 'server.js')} Entering ${code('case "electrical":')} block`);
          
          const panelCost = getPrice('electrical', 'elec_panel_200', useOverride);
          
          laborHours = 10;
          log('source', `${tag('default', 'HARDCODED')} Labor hours for 200A panel = ${val('10 hrs')}`);
          
          materialCost = panelCost + 150;
          log('calc', `Material = $${panelCost} + $150 (breakers) = ${val('$' + materialCost.toFixed(2))}`);
          
          materialCost *= regionalMultiplier;
          log('calc', `Applying regional multiplier: √ó ${regionalMultiplier} = ${val('$' + materialCost.toFixed(2))}`);
          
          equipmentCost = 150;
          break;
          
        case 'plumbing':
          log('source', `${tag('file', 'server.js')} Entering ${code('case "plumbing":')} block`);
          
          const heaterCost = getPrice('plumbing', 'plumb_heater_tank', useOverride);
          
          laborHours = 6;
          log('source', `${tag('default', 'HARDCODED')} Labor hours for tank WH = ${val('6 hrs')}`);
          
          materialCost = heaterCost;
          materialCost *= regionalMultiplier;
          log('calc', `Material = $${heaterCost} √ó ${regionalMultiplier} = ${val('$' + materialCost.toFixed(2))}`);
          
          equipmentCost = 100;
          break;
          
        default:
          laborHours = 8;
          materialCost = 500;
          equipmentCost = 100;
          log('warning', `‚ö†Ô∏è Using default fallback calculation`);
      }
      
      // Step 5: Final calculation
      log('header', `üìç STEP 5: Final Totals`);
      
      const laborCost = laborHours * hourlyRate;
      log('calc', `Labor Cost = ${laborHours.toFixed(2)} hrs √ó $${hourlyRate}/hr = ${val('$' + laborCost.toFixed(2))}`);
      
      const totalCost = laborCost + materialCost + equipmentCost;
      
      log('result', `
        <div class="summary">
          <h3>üí∞ ESTIMATE SUMMARY</h3>
          <div class="summary-row">
            <span>Labor (${laborHours.toFixed(1)} hrs √ó $${hourlyRate}/hr)</span>
            <span>$${laborCost.toFixed(2)}</span>
          </div>
          <div class="summary-row">
            <span>Materials</span>
            <span>$${materialCost.toFixed(2)}</span>
          </div>
          <div class="summary-row">
            <span>Equipment</span>
            <span>$${equipmentCost.toFixed(2)}</span>
          </div>
          <div class="summary-row">
            <span>TOTAL</span>
            <span>$${totalCost.toFixed(2)}</span>
          </div>
        </div>
      `);
      
      // Issues found
      log('header', `üö® POTENTIAL ISSUES DETECTED`);
      log('warning', `1. ${code('bls_labor_rates')} table not created in initDatabase()`);
      log('warning', `2. ${code('STATE_MULTIPLIERS_CACHE')} loading function may be missing`);
      log('warning', `3. ${code('configData')} never populated from database`);
      log('warning', `4. Material costs below 2024-2025 market rates`);
      
      renderLogs();
    }
    
    // Initialize
    runDiagnostic();
  </script>
</body>
</html>
