<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InstaBid - Multi-Trade Estimator</title>
<style>
/* FORCE OVERRIDE ELEMENTOR/THEME STYLES */
#schedule-app * {
  margin: 0 !important;
  padding: 0 !important;
  box-sizing: border-box !important;
}

#schedule-app {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  min-height: 100vh !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  padding: 20px !important;
  width: 100% !important;
}

#schedule-app .container {
  background: white !important;
  border-radius: 16px !important;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
  max-width: 600px !important;
  width: 100% !important;
  padding: 40px !important;
}

#schedule-app .success-icon {
  width: 80px !important;
  height: 80px !important;
  background: #10b981 !important;
  border-radius: 50% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  margin: 0 auto 24px !important;
  animation: scaleIn 0.5s ease !important;
}

#schedule-app .success-icon svg {
  width: 48px !important;
  height: 48px !important;
  stroke: white !important;
  stroke-width: 3 !important;
  fill: none !important;
}

@keyframes scaleIn {
  from { transform: scale(0); }
  to { transform: scale(1); }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#schedule-app h1 {
  text-align: center !important;
  color: #1f2937 !important;
  font-size: 28px !important;
  margin-bottom: 12px !important;
}

#schedule-app .subtitle {
  text-align: center !important;
  color: #6b7280 !important;
  font-size: 16px !important;
  margin-bottom: 32px !important;
}

#schedule-app .info-box {
  background: #f3f4f6 !important;
  border-radius: 8px !important;
  padding: 20px !important;
  margin-bottom: 32px !important;
}

#schedule-app .info-row {
  display: flex !important;
  justify-content: space-between !important;
  margin-bottom: 12px !important;
  font-size: 15px !important;
}

#schedule-app .info-row:last-child {
  margin-bottom: 0 !important;
}

#schedule-app .info-label {
  color: #6b7280 !important;
  font-weight: 500 !important;
}

#schedule-app .info-value {
  color: #1f2937 !important;
  font-weight: 600 !important;
}

#schedule-app .calendar-section {
  margin-bottom: 32px !important;
}

#schedule-app .calendar-section h2 {
  font-size: 18px !important;
  color: #1f2937 !important;
  margin-bottom: 16px !important;
}

#schedule-app .calendar {
  display: grid !important;
  grid-template-columns: repeat(7, 1fr) !important;
  gap: 8px !important;
  margin-bottom: 24px !important;
}

#schedule-app .calendar-header {
  text-align: center !important;
  font-size: 13px !important;
  font-weight: 600 !important;
  color: #6b7280 !important;
  padding: 8px 0 !important;
}

#schedule-app .calendar-day {
  aspect-ratio: 1 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 8px !important;
  font-size: 14px !important;
  cursor: pointer !important;
  transition: all 0.2s !important;
  border: 2px solid transparent !important;
  background: #f9fafb !important;
  color: #1f2937 !important;
}

#schedule-app .calendar-day:hover:not(.disabled):not(.selected) {
  background: #e5e7eb !important;
  transform: scale(1.05) !important;
}

#schedule-app .calendar-day.disabled {
  background: #f3f4f6 !important;
  color: #d1d5db !important;
  cursor: not-allowed !important;
}

#schedule-app .calendar-day.selected {
  background: #6366f1 !important;
  color: white !important;
  border-color: #4f46e5 !important;
  transform: scale(1.1) !important;
}

#schedule-app .calendar-day.today {
  border-color: #6366f1 !important;
}

#schedule-app .btn {
  width: 100% !important;
  padding: 16px !important;
  border: none !important;
  border-radius: 8px !important;
  font-size: 16px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.3s !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
}

#schedule-app .btn-primary {
  background: #6366f1 !important;
  color: white !important;
}

#schedule-app .btn-primary:hover:not(:disabled) {
  background: #4f46e5 !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3) !important;
}

#schedule-app .btn:disabled {
  background: #d1d5db !important;
  cursor: not-allowed !important;
  transform: none !important;
}

#schedule-app .loading {
  text-align: center !important;
  padding: 40px !important;
}

#schedule-app .spinner {
  width: 48px !important;
  height: 48px !important;
  border: 4px solid #e5e7eb !important;
  border-top-color: #6366f1 !important;
  border-radius: 50% !important;
  animation: spin 0.8s linear infinite !important;
  margin: 0 auto 16px !important;
}

#schedule-app .error {
  background: #fee2e2 !important;
  color: #991b1b !important;
  padding: 16px !important;
  border-radius: 8px !important;
  margin-bottom: 24px !important;
  text-align: center !important;
}

#schedule-app .confirmation {
  text-align: center !important;
  padding: 40px 0 !important;
}

#schedule-app .confirmation h2 {
  color: #10b981 !important;
  font-size: 24px !important;
  margin-bottom: 16px !important;
}

#schedule-app .confirmation p {
  color: #6b7280 !important;
  font-size: 16px !important;
  line-height: 1.6 !important;
}

#schedule-app .selected-date-display {
  background: #eff6ff !important;
  border: 2px solid #6366f1 !important;
  border-radius: 8px !important;
  padding: 12px !important;
  margin-bottom: 24px !important;
  text-align: center !important;
  font-weight: 600 !important;
  color: #4f46e5 !important;
}
</style>
</head>
<body>
  <div id="schedule-app">

<div class="container">
  <div class="header">
    <h1>üèóÔ∏è InstaBid</h1>
    <p>Multi-Trade Instant Estimator</p>
  </div>

  <div class="main-content">
    <div class="left-column">
      <form id="estimateForm">
        <div class="form-group">
          <label>Select Trade *</label>
          <select id="tradeSelector" required>
            <option value="">-- Select a Trade --</option>
            <option value="roofing">Roofing</option>
            <option value="hvac">HVAC</option>
            <option value="electrical">Electrical</option>
            <option value="plumbing">Plumbing</option>
            <option value="flooring">Flooring</option>
            <option value="painting">Painting</option>
        <!--<option value="general_contracting">General Contracting</option>-->
          </select>
        </div>

        <div id="dynamicFormFields"></div>

        <div class="photo-upload">
          <label>Upload Photos (Optional)</label>
          <input type="file" id="photoInput" accept="image/*" multiple>
          <div class="photo-preview" id="photoPreview"></div>
        </div>

        <div class="map-container">
          <div id="map"></div>
        </div>

        <button type="submit" class="btn-primary" id="submitBtn">Get Instant Estimate</button>
      </form>
    </div>

    <div class="right-column">
      <div class="result-section" id="resultSection">
        <h2>Your Estimate</h2>
        <div class="cost-breakdown" id="costBreakdown"></div>
        <div class="action-buttons">
          <button class="btn-action btn-email" id="emailBtn">üìß Email Sent!</button>
          <button class="btn-action btn-pdf" id="pdfBtn">üìÑ PDF</button>
          <button class="btn-action btn-contract" id="contractBtn">üìù Contract</button>
        </div>
      </div>
      <div class="error-message" id="errorMessage"></div>
    </div>
  </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5u7bMfb76Il4K9x6oP-k2wccwB1mbSP0&libraries=places"></script>
<script>
var TRADE_FORM_SCHEMA = {
  roofing: [
    { name: 'name', label: 'Full Name', type: 'text', required: true },
    { name: 'email', label: 'Email', type: 'email', required: true },
    { name: 'phone', label: 'Phone', type: 'tel', required: true },
    { name: 'address', label: 'Property Address', type: 'text', required: true },
    { name: 'city', label: 'City', type: 'text', required: true },
    { name: 'state', label: 'State', type: 'select', options: ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], required: true },
    { name: 'zip', label: 'ZIP Code', type: 'text', required: true },
    { name: 'squareFeet', label: 'Square Feet', type: 'number', required: true },
    { name: 'pitch', label: 'Roof Pitch', type: 'select', options: ['3/12', '4/12', '5/12', '6/12', '7/12', '8/12', '9/12', '10/12', '11/12', '12/12+'], required: true },
    { name: 'material', label: 'Roofing Material', type: 'select', options: ['Asphalt Shingles ($2.50/sqft)', 'Architectural Shingles ($3.50/sqft)', 'Metal ($5.00/sqft)', 'Tile ($7.00/sqft)', 'Wood Shake ($6.00/sqft)'], required: true },
    { name: 'stories', label: 'Number of Stories', type: 'number', required: true },
    { name: 'layers', label: 'Existing Layers to Remove', type: 'number', required: false },
    { name: 'chimneys', label: 'Number of Chimneys', type: 'number', required: false },
    { name: 'valleys', label: 'Number of Valleys', type: 'number', required: false },
    { name: 'needsPlywood', label: 'Needs Plywood Replacement?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'plywoodSqft', label: 'Plywood Square Feet', type: 'number', required: false },
    { name: 'existingRoofType', label: 'Existing Roof Type', type: 'select', options: ['asphalt', 'tile', 'metal', 'wood_shake'], required: false },
    { name: 'skylights', label: 'Number of Skylights', type: 'number', required: false },
    { name: 'ridgeVentFeet', label: 'Ridge Vent (Linear Feet)', type: 'number', required: false }
  ],

  hvac: [
    { name: 'name', label: 'Full Name', type: 'text', required: true },
    { name: 'email', label: 'Email', type: 'email', required: true },
    { name: 'phone', label: 'Phone', type: 'tel', required: true },
    { name: 'address', label: 'Property Address', type: 'text', required: true },
    { name: 'city', label: 'City', type: 'text', required: true },
    { name: 'state', label: 'State', type: 'select', options: ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], required: true },
    { name: 'zip', label: 'ZIP Code', type: 'text', required: true },
    { name: 'squareFeet', label: 'Square Feet', type: 'number', required: true },
    { name: 'systemType', label: 'System Type', type: 'select', options: ['Central AC', 'Heat Pump', 'Furnace', 'Ductless Mini-Split', 'Boiler'], required: true },
    { name: 'units', label: 'Number of Units', type: 'number', required: true },
    { name: 'stories', label: 'Number of Stories', type: 'number', required: true },
    { name: 'registers', label: 'Number of Registers (Supply/Return)', type: 'number', required: false },
    { name: 'accessType', label: 'Access Type', type: 'select', options: ['basement', 'crawlspace', 'attic', 'slab'], required: false },
    { name: 'existingDucts', label: 'Existing Ductwork', type: 'select', options: ['yes', 'no', 'partial'], required: false },
    { name: 'zoning', label: 'Zoning', type: 'select', options: ['single', 'multi'], required: false },
    { name: 'tonnage', label: 'Tonnage', type: 'select', options: ['1.5', '2', '2.5', '3', '3.5', '4', '5'], required: false },
    { name: 'efficiency', label: 'Efficiency Rating', type: 'select', options: ['standard_14', 'high_16_20', 'premium_20plus'], required: false },
    { name: 'gasLineNeeded', label: 'Gas Line Needed?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'electricalUpgrade', label: 'Electrical Upgrade Needed?', type: 'radio', options: ['yes', 'no'], required: false }
  ],

  electrical: [
    { name: 'name', label: 'Full Name', type: 'text', required: true },
    { name: 'email', label: 'Email', type: 'email', required: true },
    { name: 'phone', label: 'Phone', type: 'tel', required: true },
    { name: 'address', label: 'Property Address', type: 'text', required: true },
    { name: 'city', label: 'City', type: 'text', required: true },
    { name: 'state', label: 'State', type: 'select', options: ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], required: true },
    { name: 'zip', label: 'ZIP Code', type: 'text', required: true },
    { name: 'squareFeet', label: 'Square Feet', type: 'number', required: true },
    { name: 'serviceType', label: 'Service Type', type: 'select', options: ['panel', 'rewire', 'general'], required: true },
    { name: 'stories', label: 'Number of Stories', type: 'number', required: true },
    { name: 'amperage', label: 'Panel Amperage', type: 'select', options: ['100', '150', '200', '400'], required: false },
    { name: 'receptacles', label: 'Number of Receptacles (Outlets)', type: 'number', required: false },
    { name: 'switches', label: 'Number of Switches', type: 'number', required: false },
    { name: 'lightFixtures', label: 'Number of Light Fixtures', type: 'number', required: false },
    { name: 'accessType', label: 'Access Type', type: 'select', options: ['basement', 'crawlspace', 'attic', 'slab'], required: false },
    { name: 'knobAndTube', label: 'Knob & Tube Wiring?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'aluminumWiring', label: 'Aluminum Wiring?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'arcFaultBreakers', label: 'Arc-Fault Breakers Required?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'gfciOutlets', label: 'Number of GFCI Outlets', type: 'number', required: false },
    { name: 'ceilingFans', label: 'Number of Ceiling Fans', type: 'number', required: false },
    { name: 'smartHome', label: 'Smart Home Integration?', type: 'radio', options: ['yes', 'no'], required: false }
  ],

  plumbing: [
    { name: 'name', label: 'Full Name', type: 'text', required: true },
    { name: 'email', label: 'Email', type: 'email', required: true },
    { name: 'phone', label: 'Phone', type: 'tel', required: true },
    { name: 'address', label: 'Property Address', type: 'text', required: true },
    { name: 'city', label: 'City', type: 'text', required: true },
    { name: 'state', label: 'State', type: 'select', options: ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], required: true },
    { name: 'zip', label: 'ZIP Code', type: 'text', required: true },
    { name: 'squareFeet', label: 'Square Feet', type: 'number', required: false },
    { name: 'serviceType', label: 'Service Type', type: 'select', options: ['repipe', 'water_heater', 'fixture', 'general'], required: true },
    { name: 'stories', label: 'Number of Stories', type: 'number', required: true },
    { name: 'bathrooms', label: 'Number of Bathrooms', type: 'number', required: true },
    { name: 'accessType', label: 'Access Type', type: 'select', options: ['basement', 'crawlspace', 'slab'], required: false },
    { name: 'kitchens', label: 'Number of Kitchens', type: 'number', required: false },
    { name: 'laundryRooms', label: 'Number of Laundry Rooms', type: 'number', required: false },
    { name: 'heaterType', label: 'Water Heater Type', type: 'select', options: ['tank', 'tankless'], required: false },
    { name: 'waterHeaterLocation', label: 'Water Heater Location', type: 'select', options: ['garage', 'basement', 'attic', 'closet'], required: false },
    { name: 'gasLineNeeded', label: 'Gas Line Needed?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'sewerLineType', label: 'Sewer Line Type', type: 'select', options: ['city', 'septic'], required: false },
    { name: 'mainLineReplacement', label: 'Main Line Replacement?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'garbageDisposal', label: 'Garbage Disposal?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'iceMaker', label: 'Ice Maker Line?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'waterSoftener', label: 'Water Softener?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'fixtures', label: 'Number of Fixtures', type: 'number', required: false }
  ],

  flooring: [
    { name: 'name', label: 'Full Name', type: 'text', required: true },
    { name: 'email', label: 'Email', type: 'email', required: true },
    { name: 'phone', label: 'Phone', type: 'tel', required: true },
    { name: 'address', label: 'Property Address', type: 'text', required: true },
    { name: 'city', label: 'City', type: 'text', required: true },
    { name: 'state', label: 'State', type: 'select', options: ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], required: true },
    { name: 'zip', label: 'ZIP Code', type: 'text', required: true },
    { name: 'squareFeet', label: 'Square Feet', type: 'number', required: true },
    { name: 'floorType', label: 'Flooring Type', type: 'select', options: ['hardwood', 'engineered_hardwood', 'laminate', 'tile', 'carpet', 'vinyl', 'lvp'], required: true },
    { name: 'stories', label: 'Number of Stories', type: 'number', required: true },
    { name: 'rooms', label: 'Number of Rooms', type: 'number', required: false },
    { name: 'needRemoval', label: 'Remove Existing Flooring?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'stairs', label: 'Include Stairs?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'stairSteps', label: 'Number of Stair Steps', type: 'number', required: false },
    { name: 'subfloorCondition', label: 'Subfloor Condition', type: 'select', options: ['good', 'needs_repair', 'needs_replacement'], required: false },
    { name: 'moistureIssues', label: 'Moisture Issues?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'transitionStrips', label: 'Number of Transition Strips', type: 'number', required: false },
    { name: 'baseboardRemoval', label: 'Remove/Reinstall Baseboard?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'floorHeating', label: 'Radiant Floor Heating?', type: 'radio', options: ['yes', 'no'], required: false }
  ],

  painting: [
    { name: 'name', label: 'Full Name', type: 'text', required: true },
    { name: 'email', label: 'Email', type: 'email', required: true },
    { name: 'phone', label: 'Phone', type: 'tel', required: true },
    { name: 'address', label: 'Property Address', type: 'text', required: true },
    { name: 'city', label: 'City', type: 'text', required: true },
    { name: 'state', label: 'State', type: 'select', options: ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], required: true },
    { name: 'zip', label: 'ZIP Code', type: 'text', required: true },
    { name: 'squareFeet', label: 'Square Feet', type: 'number', required: true },
    { name: 'paintType', label: 'Paint Type', type: 'select', options: ['interior', 'exterior', 'both'], required: true },
    { name: 'stories', label: 'Number of Stories', type: 'number', required: true },
    { name: 'coats', label: 'Number of Coats', type: 'select', options: ['1', '2', '3'], required: false },
    { name: 'rooms', label: 'Number of Rooms', type: 'number', required: false },
    { name: 'includeCeilings', label: 'Include Ceilings?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'includeTrim', label: 'Include Trim?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'doorCount', label: 'Number of Doors', type: 'number', required: false },
    { name: 'windowCount', label: 'Number of Windows', type: 'number', required: false },
    { name: 'sidingType', label: 'Siding Type (Exterior)', type: 'select', options: ['wood', 'vinyl', 'brick', 'stucco', 'hardie', 'metal'], required: false },
    { name: 'sidingCondition', label: 'Siding Condition', type: 'select', options: ['excellent', 'good', 'fair', 'poor', 'needs_repair'], required: false },
    { name: 'cabinetPainting', label: 'Paint Cabinets?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'cabinetCount', label: 'Number of Cabinet Faces', type: 'number', required: false },
    { name: 'wallCondition', label: 'Wall Condition', type: 'select', options: ['smooth', 'textured', 'damaged'], required: false },
    { name: 'patchingNeeded', label: 'Patching Needed', type: 'select', options: ['none', 'minor', 'moderate', 'extensive'], required: false },
    { name: 'powerWashing', label: 'Power Washing (Exterior)?', type: 'radio', options: ['yes', 'no'], required: false },
    { name: 'leadPaint', label: 'Lead Paint Present (Pre-1978)?', type: 'radio', options: ['yes', 'no', 'unknown'], required: false },
    { name: 'colorChangeDramatic', label: 'Dramatic Color Change?', type: 'radio', options: ['yes', 'no'], required: false }
  ],

  general_contracting: [
    { name: 'name', label: 'Full Name', type: 'text', required: true },
    { name: 'email', label: 'Email', type: 'email', required: true },
    { name: 'phone', label: 'Phone', type: 'tel', required: true },
    { name: 'address', label: 'Property Address', type: 'text', required: true },
    { name: 'city', label: 'City', type: 'text', required: true },
    { name: 'state', label: 'State', type: 'select', options: ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'], required: true },
    { name: 'zip', label: 'ZIP Code', type: 'text', required: true },
    { name: 'squareFeet', label: 'Square Feet', type: 'number', required: true },
    { name: 'projectType', label: 'Project Type', type: 'select', options: ['Remodel', 'Addition', 'New Construction', 'Renovation'], required: true },
    { name: 'projectDetails', label: 'Project Details', type: 'textarea', required: true }
  ]
};

var selectedTrade = null;
var map = null;
var marker = null;
var uploadedPhotos = [];
var currentEstimateData = null;

document.getElementById('tradeSelector').addEventListener('change', function() {
  selectedTrade = this.value;
  if (selectedTrade) {
    renderForm(selectedTrade);
  } else {
    document.getElementById('dynamicFormFields').innerHTML = '';
  }
});

function renderForm(trade) {
  var container = document.getElementById('dynamicFormFields');
  container.innerHTML = '';
  
  var schema = TRADE_FORM_SCHEMA[trade];
  
  // Field-specific helpers
  var helpers = {
    squareFeet: { placeholder: '2000', hint: '' },
    pitch: { placeholder: '6/12 or 8/12', hint: 'Enter as ratio (e.g., 4/12, 6/12, 9/12)' },
    material: { placeholder: '2.50', hint: 'Material cost per square foot (e.g., 2.50, 3.75)' },
    layers: { placeholder: '1', default: '1' },
    plywoodSqft: { placeholder: '0', default: '0', hint: 'Estimated sqft of plywood decking to replace' },
    chimneys: { placeholder: '0', default: '0' },
    valleys: { placeholder: '0', default: '0' },
    skylights: { placeholder: '0', default: '0', hint: '$300 each for flashing work' },
    ridgeVentFeet: { placeholder: '0', default: '0', hint: '$10 per linear foot' },
    stories: { placeholder: '1', default: '1' }
  };
  
  for (var i = 0; i < schema.length; i++) {
    var field = schema[i];
    var formGroup = document.createElement('div');
    formGroup.className = 'form-group';
    
    var input;
    var helper = helpers[field.name] || {};
    
    if (field.type === 'radio') {
      var label = document.createElement('label');
      label.textContent = field.label + (field.required ? ' *' : '');
      formGroup.appendChild(label);
      
      var radioContainer = document.createElement('div');
      radioContainer.style.display = 'flex';
      radioContainer.style.gap = '15px';
      radioContainer.style.marginTop = '8px';
      
      for (var j = 0; j < field.options.length; j++) {
        var radioLabel = document.createElement('label');
        radioLabel.style.display = 'flex';
        radioLabel.style.alignItems = 'center';
        radioLabel.style.gap = '5px';
        radioLabel.style.fontWeight = 'normal';
        
        var radioInput = document.createElement('input');
        radioInput.type = 'radio';
        radioInput.name = field.name;
        radioInput.value = field.options[j];
        if (j === 0) radioInput.checked = true;
        
        radioLabel.appendChild(radioInput);
        radioLabel.appendChild(document.createTextNode(field.options[j]));
        radioContainer.appendChild(radioLabel);
      }
      
      formGroup.appendChild(radioContainer);
    } else if (field.type === 'checkbox') {
      var label = document.createElement('label');
      input = document.createElement('input');
      input.type = 'checkbox';
      input.name = field.name;
      input.id = field.name;
      input.value = 'yes';
      label.appendChild(input);
      label.appendChild(document.createTextNode(' ' + field.label));
      formGroup.appendChild(label);
    } else {
      var label = document.createElement('label');
      label.textContent = field.label + (field.required ? ' *' : '');
      formGroup.appendChild(label);
      
      if (field.type === 'select') {
        input = document.createElement('select');
        input.innerHTML = '<option value="">Select...</option>';
        for (var j = 0; j < field.options.length; j++) {
          var option = document.createElement('option');
          option.value = field.options[j];
          option.textContent = field.options[j];
          input.appendChild(option);
        }
      } else if (field.type === 'textarea') {
        input = document.createElement('textarea');
        input.rows = 4;
      } else {
        input = document.createElement('input');
        input.type = field.type;
        
        // Add placeholder and default value
        if (helper.placeholder) {
          input.placeholder = helper.placeholder;
        }
        if (helper.default && !field.required) {
          input.value = helper.default;
        }
        
        // Add min attribute for number fields
        if (field.type === 'number' && !field.required) {
          input.min = '0';
        }
      }
      
      input.name = field.name;
      input.id = field.name;
      input.required = field.required;
      
      formGroup.appendChild(input);
      
      // Add helper text
      if (helper.hint) {
        var small = document.createElement('small');
        small.textContent = helper.hint;
        small.style.display = 'block';
        small.style.marginTop = '5px';
        small.style.color = '#666';
        small.style.fontSize = '0.9em';
        formGroup.appendChild(small);
      }
    }
    
    container.appendChild(formGroup);
  }
  
  setTimeout(initMap, 100);
}

document.getElementById('photoInput').addEventListener('change', function(e) {
  var files = Array.prototype.slice.call(e.target.files);
  for (var i = 0; i < files.length; i++) {
    var file = files[i];
    var reader = new FileReader();
    reader.onload = function(event) {
      uploadedPhotos.push(event.target.result);
      renderPhotos();
    };
    reader.readAsDataURL(file);
  }
});

function renderPhotos() {
  var container = document.getElementById('photoPreview');
  container.innerHTML = '';
  for (var i = 0; i < uploadedPhotos.length; i++) {
    var photo = uploadedPhotos[i];
    var div = document.createElement('div');
    div.className = 'photo-item';
    div.innerHTML = '<img src="' + photo + '" alt="Photo ' + (i + 1) + '"><button type="button" onclick="removePhoto(' + i + ')">√ó</button>';
    container.appendChild(div);
  }
}

function removePhoto(index) {
  uploadedPhotos.splice(index, 1);
  renderPhotos();
}

function initMap() {
  var mapDiv = document.getElementById('map');
  map = new google.maps.Map(mapDiv, {
    center: { lat: 39.8283, lng: -98.5795 },
    zoom: 4,
    mapTypeId: 'satellite'
  });
  
  var addressInput = document.getElementById('address');
  if (addressInput) {
    var autocomplete = new google.maps.places.Autocomplete(addressInput);
    autocomplete.addListener('place_changed', function() {
      var place = autocomplete.getPlace();
      if (place.geometry) {
        map.setCenter(place.geometry.location);
        map.setZoom(18);
        
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({
          position: place.geometry.location,
          map: map
        });
        
        var components = place.address_components;
        for (var i = 0; i < components.length; i++) {
          var comp = components[i];
          if (comp.types.indexOf('locality') > -1) {
            document.getElementById('city').value = comp.long_name;
          }
          if (comp.types.indexOf('administrative_area_level_1') > -1) {
            document.getElementById('state').value = comp.short_name;
          }
          if (comp.types.indexOf('postal_code') > -1) {
            document.getElementById('zip').value = comp.long_name;
          }
        }
      }
    });
  }
}

  document.getElementById('estimateForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  var formData = new FormData(e.target);
  var data = {};
  
  // Handle regular fields
  formData.forEach(function(value, key) {
    data[key] = value;
  });
  
  // Handle unchecked checkboxes (they don't appear in FormData)
  var checkboxes = e.target.querySelectorAll('input[type="checkbox"]');
  for (var i = 0; i < checkboxes.length; i++) {
    var cb = checkboxes[i];
    if (!data[cb.name]) {
      data[cb.name] = cb.checked ? 'yes' : 'no';
    }
  }

  // STORE THE ORIGINAL FORM DATA (NOT THE RESPONSE!)
   
  currentEstimateData = Object.assign({}, data);
    // ADD THESE TWO LINES:
data.trade = selectedTrade;
data.photos = uploadedPhotos;

  var submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ Calculating...';
  
  fetch('https://roofbid-backend-production.up.railway.app/api/estimate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(function(response) {
    console.log('Response received:', response);
    return response.json().then(function(result) {
      console.log('Parsed JSON:', result);
      return { ok: response.ok, result: result };
    });
  })
  .then(function(data) {
    if (data.ok) {
      // DON'T OVERWRITE currentEstimateData HERE!
      displayResults(data.result);
    } else {
      showError(data.result.error || 'Failed to calculate estimate');
    }
    submitBtn.disabled = false;
    submitBtn.textContent = 'Get Instant Estimate';
  })
  .catch(function(error) {
    showError('Network error: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Get Instant Estimate';
  });
});

function displayResults(result) {
  var breakdown = document.getElementById('costBreakdown');
  
  var itemsHTML = '';
  result.lineItems.forEach(function(item) {
    itemsHTML += '<div class="cost-item"><span>' + item.description + ':</span><span>$' + item.amount.toFixed(2) + '</span></div>';
  });
  
  breakdown.innerHTML = itemsHTML + 
    '<div class="cost-item"><span>Subtotal:</span><span>$' + result.subtotal.toFixed(2) + '</span></div>' +
    '<div class="cost-item"><span>Tax (8.25%):</span><span>$' + result.tax.toFixed(2) + '</span></div>' +
    '<div class="cost-item"><span>Region: ' + result.msa + '</span><span>Timeline: ' + result.timeline + '</span></div>' +
    '<div class="cost-item"><span>Total Cost:</span><span>$' + result.total.toFixed(2) + '</span></div>';
  
  document.getElementById('resultSection').classList.add('active');
}

function showError(message) {
  var errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = '‚ùå ' + message;
  errorDiv.style.display = 'block';
  setTimeout(function() {
    errorDiv.style.display = 'none';
  }, 5000);
}

document.getElementById('emailBtn').addEventListener('click', function() {
  if (!currentEstimateData) return;
  
  this.disabled = true;
  this.textContent = '‚è≥ Sending...';
  
  var self = this;
  
  fetch('https://roofbid-backend-production.up.railway.app/api/estimate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(currentEstimateData)
  })
  .then(function(response) {
    return response.json().then(function(result) {
      return { ok: response.ok, result: result };
    });
  })
  .then(function(data) {
    if (data.ok) {
      alert('‚úÖ Email sent successfully!');
    } else {
      alert('‚ùå Failed to send email: ' + (data.result.error || 'Unknown error'));
    }
    self.disabled = false;
    self.textContent = 'üìß Email';
  })
  .catch(function(error) {
    alert('‚ùå Network error: ' + error.message);
    self.disabled = false;
    self.textContent = 'üìß Email';
  });
});

/*document.getElementById('pdfBtn').addEventListener('click', function() {
  if (!currentEstimateData) return;
  alert('PDF generation coming soon!');
});*/
  document.getElementById('pdfBtn').addEventListener('click', function() {
  if (!currentEstimateData) return;
  
  this.disabled = true;
  this.textContent = '‚è≥ Generating...';
  
  var self = this;
  var payload = Object.assign({}, currentEstimateData);
  payload.trade = selectedTrade;
  payload.photos = uploadedPhotos;
  
  fetch('https://roofbid-backend-production.up.railway.app/api/generate-pdf', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(function(response) {
    if (!response.ok) throw new Error('PDF generation failed');
    return response.blob();
  })
  .then(function(blob) {
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'estimate-' + (currentEstimateData.name || 'customer').replace(/\s+/g, '-') + '.pdf';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    self.disabled = false;
    self.textContent = 'üìÑ PDF';
    alert('‚úÖ PDF downloaded!');
  })
  .catch(function(error) {
    alert('‚ùå PDF error: ' + error.message);
    self.disabled = false;
    self.textContent = 'üìÑ PDF';
  });
});

  // Standalone Contract generation endpoint
document.getElementById('contractBtn').addEventListener('click', function() {
  if (!currentEstimateData) return;
  
  this.disabled = true;
  this.textContent = '‚è≥ Generating...';
  
  var self = this;
  var payload = Object.assign({}, currentEstimateData);
  payload.trade = selectedTrade;
  payload.photos = uploadedPhotos;
  
  console.log('üìù Sending contract request:', payload);
  
  fetch('https://roofbid-backend-production.up.railway.app/api/generate-contract', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(function(response) {
    console.log('Response status:', response.status);
    if (!response.ok) throw new Error('Contract generation failed');
    return response.blob();
  })
  .then(function(blob) {
    console.log('‚úÖ Blob received, size:', blob.size);
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'contract-' + (currentEstimateData.name || 'customer').replace(/\s+/g, '-') + '.pdf';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    self.disabled = false;
    self.textContent = 'üìù Contract';
    alert('‚úÖ Contract downloaded!');
  })
  .catch(function(error) {
    console.error('‚ùå Contract error:', error);
    alert('‚ùå Contract error: ' + error.message);
    self.disabled = false;
    self.textContent = 'üìù Contract';
  });
});

</script>
  </div>
</body>
</html>
